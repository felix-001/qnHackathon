<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - 智能发布控制台</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; }
        .header { background: #001529; color: white; padding: 0 24px; height: 64px; display: flex; align-items: center; font-size: 20px; font-weight: bold; }
        .container { display: flex; min-height: calc(100vh - 64px); }
        .sidebar { width: 200px; background: #f0f2f5; padding: 16px 0; }
        .menu-item { padding: 12px 24px; cursor: pointer; color: #333; text-decoration: none; display: block; }
        .menu-item:hover { background: #e6f7ff; }
        .menu-item.active { background: #1890ff; color: white; }
        .content { flex: 1; padding: 24px; background: #fff; margin: 24px; }
        .toolbar { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; }
        .btn { padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #40a9ff; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        select, input { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #fafafa; font-weight: 600; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #e6f7ff; color: #1890ff; margin-right: 4px; }
        .tag.gray { background: #f5f5f5; color: #8c8c8c; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; }
        .form-group textarea { min-height: 200px; resize: vertical; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .btn-group { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .history-item { padding: 12px; border: 1px solid #f0f0f0; border-radius: 4px; margin-bottom: 8px; background: #fafafa; }
        .history-item .time { color: #8c8c8c; font-size: 12px; }
        .history-item .change-type { font-weight: bold; color: #1890ff; }
        .history-item .change-type.create { color: #52c41a; }
        .history-item .change-type.delete { color: #ff4d4f; }
        .diff { background: #fffbe6; padding: 8px; border-left: 3px solid #faad14; margin: 8px 0; font-family: monospace; font-size: 12px; }
        .action-btn { padding: 4px 8px; font-size: 12px; margin-right: 4px; }
        .json-editor { background: #f5f5f5; padding: 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; }
        .compare-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .compare-panel { border: 1px solid #d9d9d9; border-radius: 4px; padding: 12px; }
        .compare-panel h4 { margin-bottom: 8px; color: #1890ff; }
        .compare-content { background: #f5f5f5; padding: 8px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .diff-line { padding: 2px 4px; }
        .diff-added { background: #d4edda; color: #155724; }
        .diff-removed { background: #f8d7da; color: #721c24; }
        .diff-changed { background: #fff3cd; color: #856404; }
        .diff-unchanged { color: #666; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="header">智能发布控制台</div>
    <div class="container">
        <div class="sidebar">
            <a href="/projects" class="menu-item">项目管理</a>
            <a href="/releases" class="menu-item">发布管理</a>
            <a href="/monitoring" class="menu-item">监控面板</a>
            <a href="/config" class="menu-item active">配置管理</a>
        </div>
        <div class="content">
            <div class="toolbar">
                <button class="btn" onclick="showCreateModal()">新建配置</button>
                <select id="projectFilter" onchange="loadConfigs()">
                    <option value="">选择项目</option>
                </select>
                <select id="envFilter" onchange="loadConfigs()">
                    <option value="">全部环境</option>
                    <option value="dev">开发环境</option>
                    <option value="test">测试环境</option>
                    <option value="prod">生产环境</option>
                </select>
            </div>
            <table id="configTable">
                <thead>
                    <tr>
                        <th>项目名称</th>
                        <th>环境</th>
                        <th>配置文件</th>
                        <th>描述</th>
                        <th>最后更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="configList">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置编辑</div>
            <form id="configForm" onsubmit="return false;">
                <input type="hidden" id="configId">
                <div class="form-group">
                    <label>项目 <span style="color: red;">*</span></label>
                    <select id="projectId" required onchange="updateProjectName()"></select>
                </div>
                <div class="form-group">
                    <label>环境 <span style="color: red;">*</span></label>
                    <select id="environment" required>
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="prod">生产环境</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>配置内容 (JSON格式) <span style="color: red;">*</span></label>
                    <textarea id="configContent" required placeholder='{"key": "value", "nested": {"key": "value"}}'></textarea>
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <input type="text" id="description" placeholder="简要说明配置用途">
                </div>
                <div class="form-group">
                    <label>修改原因 <span style="color: red;">*</span></label>
                    <input type="text" id="reason" required placeholder="说明修改原因">
                </div>
                <div class="form-group">
                    <label>操作人 <span style="color: red;">*</span></label>
                    <input type="text" id="operator" required placeholder="输入操作人姓名">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn" style="background: #d9d9d9; color: #333;" onclick="hideModal()">取消</button>
                    <button type="button" class="btn" onclick="saveConfig()">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置变更历史</div>
            <div id="historyList"></div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="hideHistoryModal()">关闭</button>
            </div>
        </div>
    </div>

    <div id="compareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置对比</div>
            <div id="compareContent"></div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="hideCompareModal()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        let projects = [];
        let configs = [];
        let currentConfigId = null;
        let historyData = [];

        async function init() {
            await loadProjects();
            await loadConfigs();
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/v1/projects');
                const data = await response.json();
                if (data.code === 200 && data.data) {
                    projects = data.data;
                    updateProjectSelects();
                }
            } catch (error) {
                console.error('加载项目失败:', error);
            }
        }

        function updateProjectSelects() {
            const projectFilter = document.getElementById('projectFilter');
            const projectId = document.getElementById('projectId');
            
            projectFilter.innerHTML = '<option value="">选择项目</option>';
            projectId.innerHTML = '<option value="">选择项目</option>';
            
            projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${project.id}">${project.name}</option>`;
                projectId.innerHTML += `<option value="${project.id}" data-name="${project.name}">${project.name}</option>`;
            });
        }

        function updateProjectName() {
            const select = document.getElementById('projectId');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.name) {
                window.currentProjectName = selectedOption.dataset.name;
            }
        }

        async function loadConfigs() {
            const projectId = document.getElementById('projectFilter').value;
            const environment = document.getElementById('envFilter').value;
            
            let url = '/api/v1/configs?';
            if (projectId) url += `projectId=${projectId}&`;
            if (environment) url += `environment=${environment}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    configs = data.data || [];
                    renderConfigs();
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                document.getElementById('configList').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #f5222d;">加载失败</td></tr>';
            }
        }

        function renderConfigs() {
            const tbody = document.getElementById('configList');
            if (configs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">暂无配置数据，点击"新建配置"开始创建</td></tr>';
                return;
            }
            
            tbody.innerHTML = configs.map(config => {
                const updateTime = new Date(config.updatedAt).toLocaleString('zh-CN');
                const envName = getEnvName(config.environment);
                const fileName = `${config.projectName}.json`;
                
                return `
                    <tr>
                        <td><strong>${config.projectName}</strong></td>
                        <td><span class="tag">${envName}</span></td>
                        <td><code>${fileName}</code></td>
                        <td>${config.description || '-'}</td>
                        <td>${updateTime}</td>
                        <td>
                            <button class="btn action-btn" onclick="editConfig('${config.id}')">编辑</button>
                            <button class="btn action-btn" onclick="showHistory('${config.projectId}', '${config.environment}')">历史</button>
                            <button class="btn btn-danger action-btn" onclick="deleteConfig('${config.id}')">删除</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEnvName(env) {
            const names = { dev: '开发', test: '测试', prod: '生产' };
            return names[env] || env;
        }

        function showCreateModal() {
            currentConfigId = null;
            document.getElementById('configForm').reset();
            document.getElementById('configId').value = '';
            document.getElementById('configContent').value = '{\n  "key": "value"\n}';
            document.getElementById('configModal').classList.add('active');
        }

        async function editConfig(id) {
            const config = configs.find(c => c.id === id);
            if (!config) return;
            
            currentConfigId = id;
            document.getElementById('configId').value = id;
            document.getElementById('projectId').value = config.projectId;
            window.currentProjectName = config.projectName;
            
            try {
                const contentObj = JSON.parse(config.content);
                document.getElementById('configContent').value = JSON.stringify(contentObj, null, 2);
            } catch (e) {
                document.getElementById('configContent').value = config.content;
            }
            
            document.getElementById('environment').value = config.environment;
            document.getElementById('description').value = config.description || '';
            
            document.getElementById('configModal').classList.add('active');
        }

        async function saveConfig() {
            const projectId = document.getElementById('projectId').value;
            const environment = document.getElementById('environment').value;
            const content = document.getElementById('configContent').value;
            const description = document.getElementById('description').value;
            const operator = document.getElementById('operator').value;
            const reason = document.getElementById('reason').value;

            if (!projectId) {
                alert('请选择项目');
                return;
            }

            try {
                JSON.parse(content);
            } catch (e) {
                alert('配置内容不是有效的JSON格式: ' + e.message);
                return;
            }

            const projectName = window.currentProjectName || document.getElementById('projectId').options[document.getElementById('projectId').selectedIndex].dataset.name;

            const config = {
                projectId: projectId,
                projectName: projectName,
                environment: environment,
                content: content,
                description: description
            };
            
            const requestData = {
                config: config,
                operator: operator,
                reason: reason
            };
            
            try {
                let response;
                if (currentConfigId) {
                    response = await fetch(`/api/v1/configs/${currentConfigId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                } else {
                    response = await fetch('/api/v1/configs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                }
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('保存成功');
                    hideModal();
                    await loadConfigs();
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                alert('保存失败: ' + error.message);
            }
        }

        async function deleteConfig(id) {
            if (!confirm('确定要删除这个配置吗？')) return;
            
            const operator = prompt('请输入操作人:');
            if (!operator) return;
            
            const reason = prompt('请输入删除原因:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/v1/configs/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operator, reason })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('删除成功');
                    await loadConfigs();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                console.error('删除配置失败:', error);
                alert('删除失败');
            }
        }

        async function showHistory(projectId, environment) {
            try {
                const response = await fetch(`/api/v1/configs/history?projectId=${projectId}&environment=${environment}`);
                const data = await response.json();
                if (data.code === 200) {
                    historyData = data.data || [];
                    renderHistory(historyData);
                    document.getElementById('historyModal').classList.add('active');
                }
            } catch (error) {
                console.error('加载历史失败:', error);
                alert('加载历史失败');
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('historyList');
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无历史记录</div>';
                return;
            }
            
            container.innerHTML = history.map((item, index) => {
                const changeTypeText = item.changeType === 'create' ? '创建' : item.changeType === 'update' ? '更新' : '删除';
                const changeTypeClass = item.changeType;
                
                let compareBtn = '';
                if (index < history.length - 1 && item.changeType !== 'delete') {
                    compareBtn = `<button class="btn action-btn" onclick="showCompare('${item.id}', '${history[index + 1].id}')">与上一版本对比</button>`;
                }
                
                return `
                    <div class="history-item">
                        <div><span class="change-type ${changeTypeClass}">${changeTypeText}</span></div>
                        <div class="time">${new Date(item.createdAt).toLocaleString('zh-CN')}</div>
                        <div>操作人: ${item.operator}</div>
                        <div>原因: ${item.reason}</div>
                        ${item.gitlabMR ? `<div>GitLab MR: <a href="${item.gitlabMR}" target="_blank">${item.gitlabMR}</a></div>` : ''}
                        ${compareBtn}
                    </div>
                `;
            }).join('');
        }

        async function showCompare(id1, id2) {
            try {
                const response = await fetch(`/api/v1/configs/compare?id1=${id1}&id2=${id2}`);
                const data = await response.json();
                if (data.code === 200) {
                    renderCompare(data.data);
                    hideHistoryModal();
                    document.getElementById('compareModal').classList.add('active');
                }
            } catch (error) {
                console.error('对比失败:', error);
                alert('对比失败');
            }
        }

        function getDiffLines(oldText, newText) {
            const oldLines = oldText.split('\n');
            const newLines = newText.split('\n');
            const maxLen = Math.max(oldLines.length, newLines.length);
            
            const leftLines = [];
            const rightLines = [];
            
            for (let i = 0; i < maxLen; i++) {
                const oldLine = oldLines[i] || '';
                const newLine = newLines[i] || '';
                
                if (oldLine === newLine) {
                    leftLines.push({ type: 'unchanged', content: oldLine });
                    rightLines.push({ type: 'unchanged', content: newLine });
                } else {
                    if (i < oldLines.length) {
                        leftLines.push({ type: 'removed', content: oldLine });
                    } else {
                        leftLines.push({ type: 'unchanged', content: '' });
                    }
                    
                    if (i < newLines.length) {
                        rightLines.push({ type: 'added', content: newLine });
                    } else {
                        rightLines.push({ type: 'unchanged', content: '' });
                    }
                }
            }
            
            return { leftLines, rightLines };
        }
        
        function renderDiffLines(lines) {
            return lines.map(line => {
                const cssClass = line.type === 'unchanged' ? 'diff-unchanged' : 
                                line.type === 'added' ? 'diff-added' : 'diff-removed';
                const content = line.content || ' ';
                return `<div class="diff-line ${cssClass}">${content}</div>`;
            }).join('');
        }
        
        function renderCompare(compareData) {
            const container = document.getElementById('compareContent');
            const history1 = compareData.history1;
            const history2 = compareData.history2;
            
            let content1 = history1.newContent || history1.oldContent;
            let content2 = history2.newContent || history2.oldContent;
            
            try {
                content1 = JSON.stringify(JSON.parse(content1), null, 2);
            } catch (e) {}
            
            try {
                content2 = JSON.stringify(JSON.parse(content2), null, 2);
            } catch (e) {}
            
            const { leftLines, rightLines } = getDiffLines(content2, content1);
            
            container.innerHTML = `
                <div class="compare-container">
                    <div class="compare-panel">
                        <h4>新版本</h4>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${new Date(history1.createdAt).toLocaleString('zh-CN')} - ${history1.operator}
                        </div>
                        <div class="compare-content">${renderDiffLines(rightLines)}</div>
                    </div>
                    <div class="compare-panel">
                        <h4>旧版本</h4>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${new Date(history2.createdAt).toLocaleString('zh-CN')} - ${history2.operator}
                        </div>
                        <div class="compare-content">${renderDiffLines(leftLines)}</div>
                    </div>
                </div>
            `;
        }

        function hideModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function hideHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function hideCompareModal() {
            document.getElementById('compareModal').classList.remove('active');
        }

        init();
    </script>
</body>
</html>
