<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - 智能发布控制台</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        .history-item { padding: 16px; border: 1px solid #f0f0f0; border-radius: 8px; margin-bottom: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .history-item:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .history-item .time { color: #8c8c8c; font-size: 12px; }
        .history-item .change-type { font-weight: 600; color: #1890ff; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-right: 8px; }
        .history-item .change-type.create { color: #52c41a; background: #f6ffed; }
        .history-item .change-type.delete { color: #ff4d4f; background: #fff1f0; }
        .history-item .change-type.rollback { color: #faad14; background: #fffbe6; }
        .diff { background: #fffbe6; padding: 8px; border-left: 3px solid #faad14; margin: 8px 0; font-family: monospace; font-size: 12px; }
        .json-editor { background: #f5f5f5; padding: 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; }
        .compare-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .compare-panel { border: 1px solid #d9d9d9; border-radius: 8px; padding: 16px; background: white; }
        .compare-panel h4 { margin-bottom: 12px; color: #1890ff; font-size: 16px; }
        .compare-content { background: #f5f5f5; padding: 12px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; border-radius: 6px; }
        .diff-line { padding: 3px 6px; }
        .diff-added { background: #d4edda; color: #155724; }
        .diff-removed { background: #f8d7da; color: #721c24; }
        .diff-changed { background: #fff3cd; color: #856404; }
        .diff-unchanged { color: #666; }
        .compare-toolbar { margin-bottom: 20px; padding: 16px; background: #f0f2f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .compare-info { color: #666; font-size: 13px; font-weight: 500; }
        .history-checkbox { margin-right: 8px; }
        .rule-item { padding: 10px; background: white; border: 1px solid #d9d9d9; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .rule-item select { flex: 1; }
        .rule-item input { flex: 2; }
        .stats-card { padding: 20px; background: white; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stats-card h4 { margin-bottom: 16px; color: #1890ff; font-size: 16px; font-weight: 600; }
        .stats-row { display: flex; gap: 16px; margin-bottom: 10px; align-items: center; }
        .stats-label { font-weight: 500; min-width: 120px; color: #595959; }
        .stats-value { color: #52c41a; font-weight: 600; font-size: 16px; }
    </style>
</head>
<body>
    <div class="header">智能发布控制台</div>
    <div class="container">
        <div class="sidebar">
            <a href="/projects" class="menu-item">项目管理</a>
            <a href="/releases" class="menu-item">发布管理</a>
            <a href="/monitoring" class="menu-item">监控面板</a>
            <a href="/config" class="menu-item active">配置管理</a>
        </div>
        <div class="content">
            <div style="margin-bottom: 16px; border-bottom: 2px solid #f0f0f0;">
                <button class="tab-btn active" onclick="switchTab('config')">配置管理</button>
                <button class="tab-btn" onclick="switchTab('gray')">灰度管理</button>
            </div>

            <div id="configTab" class="tab-content">
                <div class="toolbar">
                    <button class="btn" onclick="showCreateModal()">新建配置</button>
                    <select id="projectFilter" onchange="loadConfigs()">
                        <option value="">选择项目</option>
                    </select>
                    <select id="envFilter" onchange="loadConfigs()">
                        <option value="">全部环境</option>
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="prod">生产环境</option>
                    </select>
                </div>
            <table id="configTable">
                <thead>
                    <tr>
                        <th>项目名称</th>
                        <th>环境</th>
                        <th>配置文件</th>
                        <th>版本</th>
                        <th>描述</th>
                        <th>最后更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="configList">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999;">加载中...</td>
                    </tr>
                </tbody>
            </table>
            </div>

            <div id="grayTab" class="tab-content" style="display: none;">
                <div class="toolbar">
                    <button class="btn" onclick="showGrayModal()">新建灰度规则</button>
                    <select id="grayProjectFilter" onchange="loadGrayReleases()">
                        <option value="">选择项目</option>
                    </select>
                    <select id="grayEnvFilter" onchange="loadGrayReleases()">
                        <option value="">全部环境</option>
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="prod">生产环境</option>
                    </select>
                    <button class="btn" onclick="loadDeviceStats()" style="background: #52c41a;">查看设备统计</button>
                </div>
                <table id="grayTable">
                    <thead>
                        <tr>
                            <th>项目名称</th>
                            <th>环境</th>
                            <th>版本</th>
                            <th>灰度规则</th>
                            <th>状态</th>
                            <th>操作人</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="grayList">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置编辑</div>
            <form id="configForm" onsubmit="return false;">
                <input type="hidden" id="configId">
                <div class="form-group">
                    <label>项目 <span style="color: red;">*</span></label>
                    <select id="projectId" required onchange="updateProjectName()"></select>
                </div>
                <div class="form-group">
                    <label>环境 <span style="color: red;">*</span></label>
                    <select id="environment" required>
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="prod">生产环境</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>配置内容 (JSON格式) <span style="color: red;">*</span></label>
                    <textarea id="configContent" required placeholder='{"key": "value", "nested": {"key": "value"}}'></textarea>
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <input type="text" id="description" placeholder="简要说明配置用途">
                </div>
                <div class="form-group">
                    <label>修改原因 <span style="color: red;">*</span></label>
                    <input type="text" id="reason" required placeholder="说明修改原因">
                </div>
                <div class="form-group">
                    <label>操作人 <span style="color: red;">*</span></label>
                    <input type="text" id="operator" required placeholder="输入操作人姓名">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn" style="background: #d9d9d9; color: #333;" onclick="hideModal()">取消</button>
                    <button type="button" class="btn" onclick="saveConfig()">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置变更历史</div>
            <div class="compare-toolbar">
                <div class="compare-info">
                    <span id="selectedCount">已选择 0 个版本</span>
                </div>
                <button type="button" class="btn" id="compareBtn" onclick="compareSelected()" disabled style="opacity: 0.5;">对比选中版本</button>
            </div>
            <div id="historyList"></div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="hideHistoryModal()">关闭</button>
            </div>
        </div>
    </div>

    <div id="compareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">配置对比</div>
            <div id="compareContent"></div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="hideCompareModal()">关闭</button>
            </div>
        </div>
    </div>

    <div id="grayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">灰度规则配置</div>
            <form id="grayForm" onsubmit="return false;">
                <input type="hidden" id="grayId">
                <div class="form-group">
                    <label>项目 <span style="color: red;">*</span></label>
                    <select id="grayProjectId" required onchange="updateGrayProjectName()"></select>
                </div>
                <div class="form-group">
                    <label>环境 <span style="color: red;">*</span></label>
                    <select id="grayEnvironment" required onchange="loadVersionsForGray()">
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="prod">生产环境</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>版本 <span style="color: red;">*</span></label>
                    <div id="versionCheckboxes" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                        <div style="color: #999; text-align: center; padding: 20px;">请先选择项目和环境</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>灰度规则 <span style="color: red;">*</span></label>
                    <div id="rulesContainer"></div>
                    <button type="button" class="btn" onclick="addRule()" style="margin-top: 8px; font-size: 12px;">添加规则</button>
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <input type="text" id="grayDescription" placeholder="简要说明灰度目的">
                </div>
                <div class="form-group">
                    <label>操作人 <span style="color: red;">*</span></label>
                    <input type="text" id="grayOperator" required placeholder="输入操作人姓名">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn" style="background: #d9d9d9; color: #333;" onclick="hideGrayModal()">取消</button>
                    <button type="button" class="btn" onclick="saveGrayRelease()">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">设备版本统计</div>
            <div class="toolbar">
                <select id="statsProjectFilter" onchange="loadDeviceStats()">
                    <option value="">选择项目</option>
                </select>
                <select id="statsEnvFilter" onchange="loadDeviceStats()">
                    <option value="">选择环境</option>
                    <option value="dev">开发环境</option>
                    <option value="test">测试环境</option>
                    <option value="prod">生产环境</option>
                </select>
                <button class="btn" onclick="showFullReleaseConfirm()" style="background: #ff4d4f;">全量发布</button>
            </div>
            <div id="statsContent"></div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="hideStatsModal()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        let projects = [];
        let configs = [];
        let currentConfigId = null;
        let historyData = [];
        let selectedHistoryIds = [];

        async function init() {
            await loadProjects();
            await loadConfigs();
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/v1/projects');
                const data = await response.json();
                if (data.code === 200 && data.data) {
                    projects = data.data;
                    updateProjectSelects();
                }
            } catch (error) {
                console.error('加载项目失败:', error);
            }
        }

        function updateProjectSelects() {
            const projectFilter = document.getElementById('projectFilter');
            const projectId = document.getElementById('projectId');
            
            projectFilter.innerHTML = '<option value="">选择项目</option>';
            projectId.innerHTML = '<option value="">选择项目</option>';
            
            projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${project.id}">${project.name}</option>`;
                projectId.innerHTML += `<option value="${project.id}" data-name="${project.name}">${project.name}</option>`;
            });
        }

        function updateProjectName() {
            const select = document.getElementById('projectId');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.name) {
                window.currentProjectName = selectedOption.dataset.name;
            }
        }

        async function loadConfigs() {
            const projectId = document.getElementById('projectFilter').value;
            const environment = document.getElementById('envFilter').value;
            
            let url = '/api/v1/configs?';
            if (projectId) url += `projectId=${projectId}&`;
            if (environment) url += `environment=${environment}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    configs = data.data || [];
                    renderConfigs();
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                document.getElementById('configList').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f5222d;">加载失败</td></tr>';
            }
        }

        function renderConfigs() {
            const tbody = document.getElementById('configList');
            if (configs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">暂无配置数据，点击"新建配置"开始创建</td></tr>';
                return;
            }
            
            tbody.innerHTML = configs.map(config => {
                const updateTime = new Date(config.updatedAt).toLocaleString('zh-CN');
                const envName = getEnvName(config.environment);
                const fileName = `${config.projectName}.json`;
                const version = config.version || 'v1.0.0';
                
                return `
                    <tr>
                        <td><strong>${config.projectName}</strong></td>
                        <td><span class="tag">${envName}</span></td>
                        <td><code>${fileName}</code></td>
                        <td><span class="tag" style="background: #e6f7ff; color: #1890ff;">${version}</span></td>
                        <td>${config.description || '-'}</td>
                        <td>${updateTime}</td>
                        <td>
                            <button class="btn action-btn" onclick="editConfig('${config.id}')">编辑</button>
                            <button class="btn action-btn" onclick="showHistory('${config.projectId}', '${config.environment}')">历史</button>
                            <button class="btn btn-danger action-btn" onclick="deleteConfig('${config.id}')">删除</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEnvName(env) {
            const names = { dev: '开发', test: '测试', prod: '生产' };
            return names[env] || env;
        }

        function showCreateModal() {
            currentConfigId = null;
            document.getElementById('configForm').reset();
            document.getElementById('configId').value = '';
            document.getElementById('configContent').value = '{\n  "key": "value"\n}';
            document.getElementById('configModal').classList.add('active');
        }

        async function editConfig(id) {
            const config = configs.find(c => c.id === id);
            if (!config) return;
            
            currentConfigId = id;
            document.getElementById('configId').value = id;
            document.getElementById('projectId').value = config.projectId;
            window.currentProjectName = config.projectName;
            
            try {
                const contentObj = JSON.parse(config.content);
                document.getElementById('configContent').value = JSON.stringify(contentObj, null, 2);
            } catch (e) {
                document.getElementById('configContent').value = config.content;
            }
            
            document.getElementById('environment').value = config.environment;
            document.getElementById('description').value = config.description || '';
            
            document.getElementById('configModal').classList.add('active');
        }

        async function saveConfig() {
            const projectId = document.getElementById('projectId').value;
            const environment = document.getElementById('environment').value;
            const content = document.getElementById('configContent').value;
            const description = document.getElementById('description').value;
            const operator = document.getElementById('operator').value;
            const reason = document.getElementById('reason').value;

            if (!projectId) {
                alert('请选择项目');
                return;
            }

            try {
                JSON.parse(content);
            } catch (e) {
                alert('配置内容不是有效的JSON格式: ' + e.message);
                return;
            }

            const projectName = window.currentProjectName || document.getElementById('projectId').options[document.getElementById('projectId').selectedIndex].dataset.name;

            const config = {
                projectId: projectId,
                projectName: projectName,
                environment: environment,
                content: content,
                description: description
            };
            
            const requestData = {
                config: config,
                operator: operator,
                reason: reason
            };
            
            try {
                let response;
                if (currentConfigId) {
                    response = await fetch(`/api/v1/configs/${currentConfigId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                } else {
                    response = await fetch('/api/v1/configs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                }
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('保存成功');
                    hideModal();
                    await loadConfigs();
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                alert('保存失败: ' + error.message);
            }
        }

        async function deleteConfig(id) {
            if (!confirm('确定要删除这个配置吗？')) return;
            
            const operator = prompt('请输入操作人:');
            if (!operator) return;
            
            const reason = prompt('请输入删除原因:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/v1/configs/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operator, reason })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('删除成功');
                    await loadConfigs();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                console.error('删除配置失败:', error);
                alert('删除失败');
            }
        }

        async function showHistory(projectId, environment) {
            try {
                const response = await fetch(`/api/v1/configs/history?projectId=${projectId}&environment=${environment}`);
                const data = await response.json();
                if (data.code === 200) {
                    historyData = data.data || [];
                    renderHistory(historyData);
                    document.getElementById('historyModal').classList.add('active');
                }
            } catch (error) {
                console.error('加载历史失败:', error);
                alert('加载历史失败');
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('historyList');
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无历史记录</div>';
                return;
            }
            
            selectedHistoryIds = [];
            updateCompareButton();
            
            container.innerHTML = history.map((item, index) => {
                const changeTypeText = item.changeType === 'create' ? '创建' : item.changeType === 'update' ? '更新' : item.changeType === 'rollback' ? '回滚' : '删除';
                const changeTypeClass = item.changeType;
                
                let compareBtn = '';
                if (index < history.length - 1 && item.changeType !== 'delete') {
                    compareBtn = `<button class="btn action-btn" onclick="showCompare('${item.id}', '${history[index + 1].id}')">与上一版本对比</button>`;
                }
                
                let rollbackBtn = '';
                if (item.changeType !== 'delete' && item.changeType !== 'rollback') {
                    rollbackBtn = `<button class="btn action-btn" style="background: #faad14;" onclick="rollbackToVersion('${item.configId}', '${item.id}')">回滚到此版本</button>`;
                }
                
                const checkboxDisabled = item.changeType === 'delete' ? 'disabled' : '';
                const version = item.version || 'v1.0.0';
                const approverInfo = item.approver ? `<div>审批人: ${item.approver}</div>` : '';
                
                return `
                    <div class="history-item">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="history-checkbox" ${checkboxDisabled} value="${item.id}" onchange="toggleHistorySelection('${item.id}')">
                            <span class="change-type ${changeTypeClass}">${changeTypeText}</span>
                        </div>
                        <div class="time">${new Date(item.createdAt).toLocaleString('zh-CN')}</div>
                        <div>操作人: ${item.operator}</div>
                        ${approverInfo}
                        <div>版本号: <span class="tag" style="background: #e6f7ff; color: #1890ff;">${version}</span></div>
                        <div>原因: ${item.reason}</div>
                        ${item.gitlabMR ? `<div>GitLab MR: <a href="${item.gitlabMR}" target="_blank">${item.gitlabMR}</a></div>` : ''}
                        ${compareBtn}
                        ${rollbackBtn}
                    </div>
                `;
            }).join('');
        }

        function toggleHistorySelection(id) {
            const index = selectedHistoryIds.indexOf(id);
            if (index > -1) {
                selectedHistoryIds.splice(index, 1);
            } else {
                if (selectedHistoryIds.length >= 2) {
                    alert('最多只能选择2个版本进行对比');
                    const checkbox = document.querySelector(`input[value="${id}"]`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }
                selectedHistoryIds.push(id);
            }
            updateCompareButton();
        }

        function updateCompareButton() {
            const selectedCount = selectedHistoryIds.length;
            document.getElementById('selectedCount').textContent = `已选择 ${selectedCount} 个版本`;
            const compareBtn = document.getElementById('compareBtn');
            if (selectedCount === 2) {
                compareBtn.disabled = false;
                compareBtn.style.opacity = '1';
            } else {
                compareBtn.disabled = true;
                compareBtn.style.opacity = '0.5';
            }
        }

        function compareSelected() {
            if (selectedHistoryIds.length !== 2) {
                alert('请选择2个版本进行对比');
                return;
            }
            showCompare(selectedHistoryIds[0], selectedHistoryIds[1]);
        }

        async function showCompare(id1, id2) {
            try {
                const response = await fetch(`/api/v1/configs/compare?id1=${id1}&id2=${id2}`);
                const data = await response.json();
                if (data.code === 200) {
                    renderCompare(data.data);
                    hideHistoryModal();
                    document.getElementById('compareModal').classList.add('active');
                }
            } catch (error) {
                console.error('对比失败:', error);
                alert('对比失败');
            }
        }

        function getDiffLines(oldText, newText) {
            const oldLines = oldText.split('\n');
            const newLines = newText.split('\n');
            const maxLen = Math.max(oldLines.length, newLines.length);
            
            const leftLines = [];
            const rightLines = [];
            
            for (let i = 0; i < maxLen; i++) {
                const oldLine = oldLines[i] || '';
                const newLine = newLines[i] || '';
                
                if (oldLine === newLine) {
                    leftLines.push({ type: 'unchanged', content: oldLine });
                    rightLines.push({ type: 'unchanged', content: newLine });
                } else {
                    if (i < oldLines.length) {
                        leftLines.push({ type: 'removed', content: oldLine });
                    } else {
                        leftLines.push({ type: 'unchanged', content: '' });
                    }
                    
                    if (i < newLines.length) {
                        rightLines.push({ type: 'added', content: newLine });
                    } else {
                        rightLines.push({ type: 'unchanged', content: '' });
                    }
                }
            }
            
            return { leftLines, rightLines };
        }
        
        function renderDiffLines(lines) {
            return lines.map(line => {
                const cssClass = line.type === 'unchanged' ? 'diff-unchanged' : 
                                line.type === 'added' ? 'diff-added' : 'diff-removed';
                const content = line.content || ' ';
                return `<div class="diff-line ${cssClass}">${content}</div>`;
            }).join('');
        }
        
        function renderCompare(compareData) {
            const container = document.getElementById('compareContent');
            const history1 = compareData.history1;
            const history2 = compareData.history2;
            
            let content1 = history1.newContent || history1.oldContent;
            let content2 = history2.newContent || history2.oldContent;
            
            try {
                content1 = JSON.stringify(JSON.parse(content1), null, 2);
            } catch (e) {}
            
            try {
                content2 = JSON.stringify(JSON.parse(content2), null, 2);
            } catch (e) {}
            
            const { leftLines, rightLines } = getDiffLines(content2, content1);
            
            container.innerHTML = `
                <div class="compare-container">
                    <div class="compare-panel">
                        <h4>新版本</h4>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${new Date(history1.createdAt).toLocaleString('zh-CN')} - ${history1.operator}
                        </div>
                        <div class="compare-content">${renderDiffLines(rightLines)}</div>
                    </div>
                    <div class="compare-panel">
                        <h4>旧版本</h4>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${new Date(history2.createdAt).toLocaleString('zh-CN')} - ${history2.operator}
                        </div>
                        <div class="compare-content">${renderDiffLines(leftLines)}</div>
                    </div>
                </div>
            `;
        }

        function hideModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function hideHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function hideCompareModal() {
            document.getElementById('compareModal').classList.remove('active');
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.style.display = 'none');
            
            if (tab === 'config') {
                tabs[0].classList.add('active');
                document.getElementById('configTab').style.display = 'block';
            } else if (tab === 'gray') {
                tabs[1].classList.add('active');
                document.getElementById('grayTab').style.display = 'block';
                loadGrayReleases();
                updateGrayProjectSelects();
            }
        }

        function updateGrayProjectSelects() {
            const selects = ['grayProjectFilter', 'grayProjectId', 'statsProjectFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">选择项目</option>';
                projects.forEach(project => {
                    const selected = project.id === currentValue ? 'selected' : '';
                    select.innerHTML += `<option value="${project.id}" data-name="${project.name}" ${selected}>${project.name}</option>`;
                });
            });
        }

        function updateGrayProjectName() {
            const select = document.getElementById('grayProjectId');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.name) {
                window.currentGrayProjectName = selectedOption.dataset.name;
            }
            loadVersionsForGray();
        }

        async function loadVersionsForGray() {
            const projectId = document.getElementById('grayProjectId').value;
            const environment = document.getElementById('grayEnvironment').value;
            
            const container = document.getElementById('versionCheckboxes');
            
            if (!projectId || !environment) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">请先选择项目和环境</div>';
                return;
            }

            try {
                const response = await fetch(`/api/v1/configs/versions?projectId=${projectId}&environment=${environment}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.length > 0) {
                    const versions = data.data;
                    container.innerHTML = versions.map(v => `
                        <div style="padding: 4px 0;">
                            <label style="cursor: pointer; display: flex; align-items: center;">
                                <input type="checkbox" name="versionCheck" value="${v}" style="margin-right: 8px;">
                                <span>${v}</span>
                            </label>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">该项目和环境下暂无配置版本</div>';
                }
            } catch (error) {
                console.error('加载版本失败:', error);
                container.innerHTML = '<div style="color: #f5222d; text-align: center; padding: 20px;">加载失败</div>';
            }
        }

        async function loadGrayReleases() {
            const projectId = document.getElementById('grayProjectFilter').value;
            const environment = document.getElementById('grayEnvFilter').value;
            
            let url = '/api/v1/gray-releases?';
            if (projectId) url += `projectId=${projectId}&`;
            if (environment) url += `environment=${environment}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    renderGrayReleases(data.data || []);
                }
            } catch (error) {
                console.error('加载灰度配置失败:', error);
                document.getElementById('grayList').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #f5222d;">加载失败</td></tr>';
            }
        }

        function renderGrayReleases(releases) {
            const tbody = document.getElementById('grayList');
            if (releases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无灰度配置，点击"新建灰度规则"开始创建</td></tr>';
                return;
            }
            
            tbody.innerHTML = releases.map(release => {
                const createTime = new Date(release.createdAt).toLocaleString('zh-CN');
                const envName = getEnvName(release.environment);
                const statusName = release.status === 'active' ? '进行中' : '已完成';
                const statusClass = release.status === 'active' ? '' : 'gray';
                
                const rulesText = release.rules.map(rule => {
                    const dimName = { isp: '运营商', region: '大区', province: '省份', datacenter: '机房' }[rule.dimension] || rule.dimension;
                    return `${dimName}: ${rule.values.join(', ')}`;
                }).join(' | ');
                
                return `
                    <tr>
                        <td><strong>${release.projectName}</strong></td>
                        <td><span class="tag">${envName}</span></td>
                        <td><span class="tag" style="background: #fff7e6; color: #faad14;">${release.version}</span></td>
                        <td>${rulesText}</td>
                        <td><span class="tag ${statusClass}">${statusName}</span></td>
                        <td>${release.operator}</td>
                        <td>${createTime}</td>
                        <td>
                            <button class="btn action-btn" onclick="editGrayRelease('${release.id}')">编辑</button>
                            <button class="btn btn-danger action-btn" onclick="deleteGrayRelease('${release.id}')">删除</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        let ruleCounter = 0;

        function showGrayModal() {
            ruleCounter = 0;
            document.getElementById('grayForm').reset();
            document.getElementById('grayId').value = '';
            document.getElementById('rulesContainer').innerHTML = '';
            addRule();
            updateGrayProjectSelects();
            document.getElementById('grayModal').classList.add('active');
        }

        function addRule() {
            const container = document.getElementById('rulesContainer');
            const ruleId = `rule_${ruleCounter++}`;
            const ruleHtml = `
                <div class="rule-item" id="${ruleId}">
                    <select class="rule-dimension">
                        <option value="">选择维度</option>
                        <option value="isp">运营商</option>
                        <option value="region">大区</option>
                        <option value="province">省份</option>
                        <option value="datacenter">机房</option>
                    </select>
                    <input type="text" class="rule-values" placeholder="输入值，多个值用逗号分隔，如: 电信,联通">
                    <button type="button" class="btn btn-danger" onclick="removeRule('${ruleId}')" style="padding: 4px 8px; font-size: 12px;">删除</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', ruleHtml);
        }

        function removeRule(ruleId) {
            document.getElementById(ruleId).remove();
        }

        function getRules() {
            const rules = [];
            document.querySelectorAll('.rule-item').forEach(item => {
                const dimension = item.querySelector('.rule-dimension').value;
                const valuesStr = item.querySelector('.rule-values').value;
                if (dimension && valuesStr) {
                    const values = valuesStr.split(',').map(v => v.trim()).filter(v => v);
                    if (values.length > 0) {
                        rules.push({ dimension, values });
                    }
                }
            });
            return rules;
        }

        async function saveGrayRelease() {
            const projectId = document.getElementById('grayProjectId').value;
            const environment = document.getElementById('grayEnvironment').value;
            const description = document.getElementById('grayDescription').value;
            const operator = document.getElementById('grayOperator').value;
            const rules = getRules();

            const selectedVersions = Array.from(document.querySelectorAll('input[name="versionCheck"]:checked')).map(cb => cb.value);
            if (selectedVersions.length === 0) {
                alert('请至少选择一个版本');
                return;
            }
            const version = selectedVersions.join(',');

            if (!projectId || !environment || !operator) {
                alert('请填写所有必填项');
                return;
            }

            if (rules.length === 0) {
                alert('请至少添加一条灰度规则');
                return;
            }

            const projectName = window.currentGrayProjectName || document.getElementById('grayProjectId').options[document.getElementById('grayProjectId').selectedIndex].dataset.name;

            const grayRelease = {
                projectId,
                projectName,
                environment,
                version,
                rules,
                description,
                operator
            };

            try {
                const grayId = document.getElementById('grayId').value;
                let response;
                if (grayId) {
                    response = await fetch(`/api/v1/gray-releases/${grayId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(grayRelease)
                    });
                } else {
                    response = await fetch('/api/v1/gray-releases', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(grayRelease)
                    });
                }

                const data = await response.json();
                if (data.code === 200) {
                    alert('保存成功');
                    hideGrayModal();
                    loadGrayReleases();
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                console.error('保存灰度配置失败:', error);
                alert('保存失败: ' + error.message);
            }
        }

        async function editGrayRelease(id) {
            try {
                const response = await fetch(`/api/v1/gray-releases/${id}`);
                const data = await response.json();
                if (data.code === 200) {
                    const release = data.data;
                    document.getElementById('grayId').value = id;
                    document.getElementById('grayProjectId').value = release.projectId;
                    window.currentGrayProjectName = release.projectName;
                    document.getElementById('grayEnvironment').value = release.environment;
                    document.getElementById('grayDescription').value = release.description || '';
                    
                    await loadVersionsForGray();
                    
                    const selectedVersions = release.version.split(',');
                    selectedVersions.forEach(v => {
                        const checkbox = document.querySelector(`input[name="versionCheck"][value="${v}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    
                    const container = document.getElementById('rulesContainer');
                    container.innerHTML = '';
                    ruleCounter = 0;
                    
                    release.rules.forEach(rule => {
                        addRule();
                        const lastRule = container.lastElementChild;
                        lastRule.querySelector('.rule-dimension').value = rule.dimension;
                        lastRule.querySelector('.rule-values').value = rule.values.join(', ');
                    });
                    
                    document.getElementById('grayModal').classList.add('active');
                }
            } catch (error) {
                console.error('加载灰度配置失败:', error);
                alert('加载失败');
            }
        }

        async function deleteGrayRelease(id) {
            if (!confirm('确定要删除这个灰度配置吗？')) return;
            
            try {
                const response = await fetch(`/api/v1/gray-releases/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('删除成功');
                    loadGrayReleases();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                console.error('删除灰度配置失败:', error);
                alert('删除失败');
            }
        }

        function hideGrayModal() {
            document.getElementById('grayModal').classList.remove('active');
        }

        async function loadDeviceStats() {
            updateGrayProjectSelects();
            const projectId = document.getElementById('statsProjectFilter')?.value || document.getElementById('grayProjectFilter')?.value;
            const environment = document.getElementById('statsEnvFilter')?.value || document.getElementById('grayEnvFilter')?.value;
            
            if (!projectId || !environment) {
                alert('请先选择项目和环境');
                return;
            }

            try {
                const response = await fetch(`/api/v1/gray-releases/device-stats?projectId=${projectId}&environment=${environment}`);
                const data = await response.json();
                if (data.code === 200) {
                    renderDeviceStats(data.data || []);
                    document.getElementById('statsModal').classList.add('active');
                } else {
                    alert('加载统计失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载设备统计失败:', error);
                alert('加载失败');
            }
        }

        function renderDeviceStats(stats) {
            const container = document.getElementById('statsContent');
            if (stats.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无设备数据</div>';
                return;
            }

            container.innerHTML = stats.map(stat => {
                const dimensions = Object.entries(stat.byDimension || {})
                    .map(([key, value]) => {
                        const parts = key.split('_');
                        const dimType = { isp: '运营商', region: '大区', province: '省份', datacenter: '机房' }[parts[0]] || parts[0];
                        const dimValue = parts.slice(1).join('_');
                        return `<div class="stats-row"><span class="stats-label">${dimType} - ${dimValue}:</span><span class="stats-value">${value} 台</span></div>`;
                    }).join('');

                return `
                    <div class="stats-card">
                        <h4>版本: ${stat.version}</h4>
                        <div class="stats-row">
                            <span class="stats-label">设备总数:</span>
                            <span class="stats-value">${stat.deviceCount} 台</span>
                        </div>
                        ${dimensions}
                    </div>
                `;
            }).join('');
        }

        function showFullReleaseConfirm() {
            const projectId = document.getElementById('statsProjectFilter').value;
            const environment = document.getElementById('statsEnvFilter').value;
            
            if (!projectId || !environment) {
                alert('请先选择项目和环境');
                return;
            }

            const version = prompt('请输入要全量发布的版本号:');
            if (!version) return;

            const operator = prompt('请输入操作人:');
            if (!operator) return;

            if (!confirm(`确定要将所有设备更新到版本 ${version} 吗？`)) return;

            fullRelease(projectId, environment, version, operator);
        }

        async function fullRelease(projectId, environment, version, operator) {
            try {
                const response = await fetch('/api/v1/gray-releases/full-release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId, environment, version, operator })
                });

                const data = await response.json();
                if (data.code === 200) {
                    alert('全量发布成功');
                    loadDeviceStats();
                    loadGrayReleases();
                } else {
                    alert('全量发布失败: ' + data.message);
                }
            } catch (error) {
                console.error('全量发布失败:', error);
                alert('全量发布失败');
            }
        }

        function hideStatsModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        async function rollbackToVersion(configId, historyId) {
            const operator = prompt('请输入操作人:');
            if (!operator) return;
            
            const reason = prompt('请输入回滚原因:');
            if (!reason) return;
            
            if (!confirm('确定要回滚到此版本吗？')) return;
            
            try {
                const response = await fetch(`/api/v1/configs/${configId}/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ historyId, operator, reason })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    alert('回滚成功');
                    hideHistoryModal();
                    await loadConfigs();
                } else {
                    alert('回滚失败: ' + data.message);
                }
            } catch (error) {
                console.error('回滚失败:', error);
                alert('回滚失败');
            }
        }

        init();
    </script>
</body>
</html>
