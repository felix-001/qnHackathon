<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布管理 - 智能发布控制台</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .delete-mode { background: #ffe7ba; }
    </style>
</head>
<body>
    <div class="header">智能发布控制台</div>
    <div class="container">
        <div class="sidebar">
            <a href="/projects" class="menu-item">项目管理</a>
            <a href="/releases" class="menu-item active">发布管理</a>
            <a href="/monitoring" class="menu-item">监控面板</a>
            <a href="/config" class="menu-item">配置管理</a>
        </div>
        <div class="content">
            <button class="btn" onclick="showModal()">创建发布</button>
            <button class="btn btn-secondary" id="toggleDeleteMode" onclick="toggleDeleteMode()">进入删除模式</button>
            <button class="btn btn-danger" id="deleteSelected" onclick="deleteSelected()" style="display: none;">删除选中</button>
            <table>
                <thead>
                    <tr>
                        <th id="checkboxHeader" style="display: none; width: 50px;">
                            <input type="checkbox" id="selectAll" onchange="selectAllReleases()">
                        </th>
                        <th>项目名称</th>
                        <th>版本</th>
                        <th>环境</th>
                        <th>策略</th>
                        <th>状态</th>
                        <th>发布人</th>
                        <th>构建包</th>
                        <th>GitLab PR</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="releaseList"></tbody>
            </table>
        </div>
    </div>

    <div id="grayRecordsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <h2>灰度发布记录</h2>
            <div id="grayRecordsContent" style="margin: 20px 0;"></div>
            <button type="button" class="btn" onclick="hideGrayRecordsModal()">关闭</button>
        </div>
    </div>

    <div id="grayReleaseModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>创建灰度发布策略</h2>
            <form id="grayReleaseForm">
                <div class="form-group">
                    <label>策略类型</label>
                    <select id="grayStrategyType" onchange="updateGrayStrategyForm()">
                        <option value="simple">简单规则</option>
                        <option value="advanced">高级策略</option>
                    </select>
                </div>
                
                <div id="simpleGrayRulesGroup" class="form-group">
                    <label>灰度规则 <button type="button" class="btn" onclick="addGrayRule()" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">添加规则</button></label>
                    <div id="grayRulesContainer"></div>
                </div>
                
                <div id="advancedGrayStrategiesGroup" class="form-group" style="display: none;">
                    <label>高级策略 <button type="button" class="btn" onclick="addGrayStrategy()" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">添加策略</button></label>
                    <div id="grayStrategiesContainer"></div>
                </div>
                
                <div id="grayRuleLogicGroup" class="form-group" style="display: none;">
                    <label>策略组合逻辑</label>
                    <select id="grayRuleLogic">
                        <option value="AND">AND (所有策略都满足)</option>
                        <option value="OR">OR (任一策略满足)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">创建灰度策略</button>
                <button type="button" class="btn" onclick="hideGrayReleaseModal()">取消</button>
            </form>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">创建发布任务</h2>
            <form id="releaseForm">
                <input type="hidden" name="id" id="releaseId">
                <div class="form-group">
                    <label>项目名称</label>
                    <select name="projectId" id="projectSelect" required>
                        <option value="">请选择项目</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>应用ID</label>
                    <input type="text" name="applicationId" required>
                </div>
                <div class="form-group">
                    <label>版本</label>
                    <input type="text" name="version" required>
                </div>
                <div class="form-group">
                    <label>环境</label>
                    <select name="environment">
                        <option value="dev">开发环境</option>
                        <option value="test">测试环境</option>
                        <option value="staging">预发布环境</option>
                        <option value="production">生产环境</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>发布策略</label>
                    <select name="strategy">
                        <option value="blue-green">蓝绿部署</option>
                        <option value="canary">金丝雀发布</option>
                        <option value="rolling-update">滚动更新</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>GitLab PR链接</label>
                    <input type="text" name="gitlabPrUrl">
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <textarea name="description"></textarea>
                </div>
                <button type="submit" class="btn">提交</button>
                <button type="button" class="btn" onclick="hideModal()">取消</button>
            </form>
        </div>
    </div>

    <script>
        let currentReleases = [];
        let editingReleaseId = null;
        let deleteMode = false;
        let selectedReleases = new Set();
        let projects = [];

        function showModal() {
            document.getElementById('modalTitle').textContent = '创建发布任务';
            document.getElementById('releaseForm').reset();
            document.getElementById('releaseId').value = '';
            editingReleaseId = null;
            loadProjects();
            document.getElementById('modal').classList.add('active');
        }
        function hideModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('releaseForm').reset();
            editingReleaseId = null;
        }

        function getStatusTag(status) {
            const map = {
                'pending_approval': '<span class="tag tag-orange">待审批</span>',
                'approved': '<span class="tag tag-blue">已批准</span>',
                'deploying': '<span class="tag tag-blue">发布中</span>',
                'completed': '<span class="tag tag-green">发布完成</span>',
                'failed': '<span class="tag tag-red">失败</span>',
                'rolled_back': '<span class="tag">已回滚</span>'
            };
            return map[status] || status;
        }

        function getActionButton(release) {
            if (release.status === 'pending_approval') {
                return `<button class="btn btn-edit" onclick="approveRelease('${release.id}')">review通过</button>`;
            } else if (release.status === 'approved') {
                return `<button class="btn" onclick="deployRelease('${release.id}')">发布</button>`;
            } else if (release.status === 'completed') {
                return `
                    <div class="action-buttons">
                        <button class="btn-rollback" onclick="rollback('${release.id}')">回滚</button>
                        <button class="btn-full-release" onclick="fullRelease('${release.id}')">全量</button>
                        <button class="btn-gray-release" onclick="grayRelease('${release.id}')">灰度</button>
                        <button class="btn-more" onclick="showMoreMenu('${release.id}', event)">更多</button>
                    </div>
                `;
            }
            return '';
        }

        function loadReleases() {
            fetch('/api/v1/releases')
                .then(res => res.json())
                .then(data => {
                    currentReleases = data.data || [];
                    const tbody = document.getElementById('releaseList');
                    tbody.innerHTML = (data.data || []).map(r => `
                        <tr>
                            <td style="display: ${deleteMode ? 'table-cell' : 'none'};">
                                <input type="checkbox" class="release-checkbox" value="${r.id}" onchange="updateSelection('${r.id}')">
                            </td>
                            <td>${r.projectName || r.projectId || '-'}</td>
                            <td>${r.version}</td>
                            <td>${r.environment}</td>
                            <td>${r.strategy}</td>
                            <td>${getStatusTag(r.status)}</td>
                            <td>${r.scheduler}</td>
                            <td>${r.tarFileName || '构建中...'}</td>
                            <td>${r.gitlabPrUrl ? `<a href="${r.gitlabPrUrl}" target="_blank">查看PR</a>` : '构建中...'}</td>
                            <td>${new Date(r.createdAt).toLocaleString()}</td>
                            <td>${getActionButton(r)}</td>
                        </tr>
                    `).join('');
                });
        }

        function loadProjects() {
            fetch('/api/v1/projects')
                .then(res => res.json())
                .then(data => {
                    projects = data.data || [];
                    const select = document.getElementById('projectSelect');
                    select.innerHTML = '<option value="">请选择项目</option>';
                    projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        select.appendChild(option);
                    });
                });
        }

        function editRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (release) {
                editingReleaseId = id;
                document.getElementById('modalTitle').textContent = '编辑发布任务';
                document.getElementById('releaseId').value = release.id;
                loadProjects();
                setTimeout(() => {
                    document.querySelector('select[name="projectId"]').value = release.projectId || '';
                }, 100);
                document.querySelector('input[name="applicationId"]').value = release.applicationId || '';
                document.querySelector('input[name="version"]').value = release.version || '';
                document.querySelector('select[name="environment"]').value = release.environment || '';
                document.querySelector('select[name="strategy"]').value = release.strategy || '';
                document.querySelector('input[name="gitlabPrUrl"]').value = release.gitlabPrUrl || '';
                document.querySelector('textarea[name="description"]').value = release.description || '';
                document.getElementById('modal').classList.add('active');
            }
        }

        document.getElementById('releaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            if (editingReleaseId) {
                data.id = editingReleaseId;
                fetch(`/api/v1/releases/${editingReleaseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    hideModal();
                    loadReleases();
                });
            } else {
                data.id = 'rel-' + Date.now();
                data.scheduler = 'admin';
                fetch('/api/v1/releases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    hideModal();
                    loadReleases();
                });
            }
        });

        function rollback(id) {
            if (confirm('确定回滚?')) {
                fetch(`/api/v1/releases/${id}/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetVersion: 'previous', reason: '手动回滚' })
                }).then(() => loadReleases());
            }
        }

        function approveRelease(id) {
            if (confirm('确认review通过?')) {
                fetch(`/api/v1/releases/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(() => {
                    loadReleases();
                });
            }
        }

        function deployRelease(id) {
            if (confirm('确认发布?')) {
                fetch(`/api/v1/releases/${id}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(() => {
                    setTimeout(() => loadReleases(), 1000);
                });
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedReleases.clear();
            
            const toggleBtn = document.getElementById('toggleDeleteMode');
            const deleteBtn = document.getElementById('deleteSelected');
            const checkboxHeader = document.getElementById('checkboxHeader');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (deleteMode) {
                toggleBtn.textContent = '退出删除模式';
                toggleBtn.classList.add('btn-secondary');
                deleteBtn.style.display = 'inline-block';
                checkboxHeader.style.display = 'table-cell';
            } else {
                toggleBtn.textContent = '进入删除模式';
                toggleBtn.classList.remove('btn-secondary');
                deleteBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
                selectAllCheckbox.checked = false;
            }
            
            loadReleases();
        }

        function updateSelection(id) {
            if (selectedReleases.has(id)) {
                selectedReleases.delete(id);
            } else {
                selectedReleases.add(id);
            }
            
            const deleteBtn = document.getElementById('deleteSelected');
            deleteBtn.textContent = `删除选中 (${selectedReleases.size})`;
            
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.release-checkbox');
            selectAllCheckbox.checked = checkboxes.length > 0 && selectedReleases.size === checkboxes.length;
        }

        function selectAllReleases() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.release-checkbox');
            
            selectedReleases.clear();
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedReleases.add(cb.value);
                }
            });
            
            const deleteBtn = document.getElementById('deleteSelected');
            deleteBtn.textContent = `删除选中 (${selectedReleases.size})`;
        }

        function deleteSelected() {
            if (selectedReleases.size === 0) {
                alert('请至少选择一项');
                return;
            }
            
            const count = selectedReleases.size;
            if (confirm(`确定删除选中的 ${count} 项发布任务?`)) {
                const ids = Array.from(selectedReleases);
                fetch('/api/v1/releases/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 0) {
                        selectedReleases.clear();
                        loadReleases();
                        alert('删除成功');
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(err => {
                    alert('删除失败: ' + err.message);
                });
            }
        }

        function fullRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            if (confirm(`确认对版本 ${release.version} 执行全量发布?`)) {
                fetch('/api/v1/gray-releases/full-release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        releaseId: id,
                        projectId: release.projectId,
                        environment: release.environment,
                        version: release.version,
                        strategy: release.strategy,
                        description: '全量发布',
                        operator: 'admin'
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200 || data.code === 0) {
                        alert('✅ 全量发布成功');
                        loadReleases();
                    } else {
                        alert('❌ 全量发布失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(err => {
                    alert('❌ 全量发布失败: ' + err.message);
                });
            }
        }

        let currentGrayRelease = null;
        let grayRuleCounter = 0;
        let grayStrategyCounter = 0;

        function grayRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            currentGrayRelease = release;
            grayRuleCounter = 0;
            grayStrategyCounter = 0;
            document.getElementById('grayReleaseForm').reset();
            document.getElementById('grayStrategyType').value = 'simple';
            document.getElementById('grayRulesContainer').innerHTML = '';
            document.getElementById('grayStrategiesContainer').innerHTML = '';
            updateGrayStrategyForm();
            addGrayRule();
            document.getElementById('grayReleaseModal').classList.add('active');
        }

        function hideGrayReleaseModal() {
            document.getElementById('grayReleaseModal').classList.remove('active');
            currentGrayRelease = null;
        }

        function updateGrayStrategyForm() {
            const strategyType = document.getElementById('grayStrategyType').value;
            const simpleGroup = document.getElementById('simpleGrayRulesGroup');
            const advancedGroup = document.getElementById('advancedGrayStrategiesGroup');
            const logicGroup = document.getElementById('grayRuleLogicGroup');
            
            if (strategyType === 'advanced') {
                simpleGroup.style.display = 'none';
                advancedGroup.style.display = 'block';
                logicGroup.style.display = 'block';
            } else {
                simpleGroup.style.display = 'block';
                advancedGroup.style.display = 'none';
                logicGroup.style.display = 'none';
            }
        }

        function addGrayRule() {
            const container = document.getElementById('grayRulesContainer');
            const ruleId = `gray_rule_${grayRuleCounter++}`;
            const ruleHtml = `
                <div class="rule-item" id="${ruleId}" style="padding: 10px; background: white; border: 1px solid #d9d9d9; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                    <select class="gray-rule-dimension" style="flex: 1;">
                        <option value="">选择维度</option>
                        <option value="isp">运营商</option>
                        <option value="region">大区</option>
                        <option value="province">省份</option>
                        <option value="datacenter">机房</option>
                    </select>
                    <input type="text" class="gray-rule-values" placeholder="输入值，多个值用逗号分隔，如: 电信,联通" style="flex: 2;">
                    <button type="button" class="btn btn-danger" onclick="removeGrayRule('${ruleId}')" style="padding: 4px 8px; font-size: 12px;">删除</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', ruleHtml);
        }

        function removeGrayRule(ruleId) {
            document.getElementById(ruleId).remove();
        }

        function addGrayStrategy() {
            const container = document.getElementById('grayStrategiesContainer');
            const strategyId = `gray_strategy_${grayStrategyCounter++}`;
            const strategyHtml = `
                <div class="rule-item" id="${strategyId}" style="padding: 10px; background: white; border: 1px solid #d9d9d9; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                    <select class="gray-strategy-type" onchange="updateGrayStrategyFields('${strategyId}')" style="flex: 1;">
                        <option value="">选择策略类型</option>
                        <option value="percentage">百分比灰度</option>
                        <option value="hash">哈希灰度</option>
                        <option value="whitelist">白名单</option>
                        <option value="blacklist">黑名单</option>
                        <option value="dimension">维度匹配</option>
                    </select>
                    <div class="gray-strategy-fields" style="flex: 2; display: flex; gap: 10px;"></div>
                    <button type="button" class="btn btn-danger" onclick="removeGrayStrategy('${strategyId}')" style="padding: 4px 8px; font-size: 12px;">删除</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', strategyHtml);
        }

        function removeGrayStrategy(strategyId) {
            document.getElementById(strategyId).remove();
        }

        function updateGrayStrategyFields(strategyId) {
            const item = document.getElementById(strategyId);
            const type = item.querySelector('.gray-strategy-type').value;
            const fieldsContainer = item.querySelector('.gray-strategy-fields');
            
            if (type === 'percentage') {
                fieldsContainer.innerHTML = '<input type="number" class="gray-strategy-value" placeholder="百分比 (1-100)" min="1" max="100" style="flex: 1;">';
            } else if (type === 'hash') {
                fieldsContainer.innerHTML = `
                    <select class="gray-strategy-value" style="flex: 1;">
                        <option value="nodeId">基于节点ID</option>
                        <option value="nodeName">基于节点名称</option>
                    </select>
                `;
            } else if (type === 'whitelist' || type === 'blacklist') {
                fieldsContainer.innerHTML = '<input type="text" class="gray-strategy-value" placeholder="节点ID列表，逗号分隔" style="flex: 1;">';
            } else if (type === 'dimension') {
                fieldsContainer.innerHTML = `
                    <select class="gray-strategy-dimension" style="flex: 1;">
                        <option value="">选择维度</option>
                        <option value="isp">运营商</option>
                        <option value="region">大区</option>
                        <option value="province">省份</option>
                        <option value="datacenter">机房</option>
                    </select>
                    <input type="text" class="gray-strategy-value" placeholder="输入值，逗号分隔" style="flex: 1;">
                `;
            } else {
                fieldsContainer.innerHTML = '';
            }
        }

        function getGrayRules() {
            const rules = [];
            document.querySelectorAll('#grayRulesContainer .rule-item').forEach(item => {
                const dimension = item.querySelector('.gray-rule-dimension').value;
                const valuesStr = item.querySelector('.gray-rule-values').value;
                if (dimension && valuesStr) {
                    rules.push({
                        dimension: dimension,
                        values: valuesStr.split(',').map(v => v.trim()).filter(v => v)
                    });
                }
            });
            return rules;
        }

        function getGrayStrategies() {
            const strategies = [];
            document.querySelectorAll('#grayStrategiesContainer .rule-item').forEach(item => {
                const type = item.querySelector('.gray-strategy-type').value;
                if (!type) return;
                
                const strategy = { type: type };
                
                if (type === 'percentage') {
                    const percentage = parseInt(item.querySelector('.gray-strategy-value').value);
                    if (percentage >= 1 && percentage <= 100) {
                        strategy.percentage = percentage;
                    } else {
                        return;
                    }
                } else if (type === 'hash') {
                    strategy.hashKey = item.querySelector('.gray-strategy-value').value;
                } else if (type === 'whitelist' || type === 'blacklist') {
                    const valuesStr = item.querySelector('.gray-strategy-value').value;
                    if (valuesStr) {
                        strategy.values = valuesStr.split(',').map(v => v.trim()).filter(v => v);
                    } else {
                        return;
                    }
                } else if (type === 'dimension') {
                    const dimension = item.querySelector('.gray-strategy-dimension').value;
                    const valuesStr = item.querySelector('.gray-strategy-value').value;
                    if (dimension && valuesStr) {
                        strategy.dimension = dimension;
                        strategy.values = valuesStr.split(',').map(v => v.trim()).filter(v => v);
                    } else {
                        return;
                    }
                }
                
                strategies.push(strategy);
            });
            return strategies;
        }

        document.getElementById('grayReleaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentGrayRelease) return;
            
            const strategyType = document.getElementById('grayStrategyType').value;
            const config = {
                projectId: currentGrayRelease.projectId,
                projectName: currentGrayRelease.projectName,
                environment: currentGrayRelease.environment,
                version: currentGrayRelease.version,
                status: 'active',
                operator: 'admin'
            };
            
            if (strategyType === 'advanced') {
                const strategies = getGrayStrategies();
                if (strategies.length === 0) {
                    alert('❌ 请至少配置一个有效的策略');
                    return;
                }
                config.strategyType = 'advanced';
                config.strategies = strategies;
                config.ruleLogic = document.getElementById('grayRuleLogic').value;
            } else {
                const rules = getGrayRules();
                if (rules.length === 0) {
                    alert('❌ 请至少配置一个有效的规则');
                    return;
                }
                config.rules = rules;
            }
            
            fetch('/api/v1/gray-releases', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200 || data.code === 0) {
                    alert('✅ 灰度发布策略创建成功');
                    hideGrayReleaseModal();
                    loadReleases();
                } else {
                    alert('❌ 灰度发布策略创建失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(err => {
                alert('❌ 灰度发布策略创建失败: ' + err.message);
            });
        });

        function showMoreMenu(id, event) {
            event.stopPropagation();
            
            const existingMenu = document.getElementById('moreMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            const menu = document.createElement('div');
            menu.id = 'moreMenu';
            menu.className = 'more-menu';
            
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            const menuItems = [
                { icon: '📋', label: '查看详情', action: () => alert('版本详情:\n' + JSON.stringify(release, null, 2)) },
                { icon: '🎯', label: '查看灰度记录', action: () => showGrayRecords(id) },
                { icon: '📑', label: '复制版本', action: () => copyRelease(id) },
                { icon: '🔍', label: '对比版本', action: () => alert('对比版本功能开发中...') },
                { icon: '📝', label: '查看部署日志', action: () => alert('部署日志:\n发布时间: ' + new Date(release.createdAt).toLocaleString()) },
                { icon: '✏️', label: '编辑版本信息', action: () => editRelease(id) },
                { divider: true },
                { icon: '💾', label: '导出版本报告', action: () => exportRelease(id) }
            ];
            
            menuItems.forEach(item => {
                if (item.divider) {
                    const divider = document.createElement('div');
                    divider.className = 'more-menu-divider';
                    menu.appendChild(divider);
                } else {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'more-menu-item';
                    menuItem.innerHTML = `<span>${item.icon}</span><span>${item.label}</span>`;
                    menuItem.onclick = () => {
                        item.action();
                        menu.remove();
                    };
                    menu.appendChild(menuItem);
                }
            });
            
            document.body.appendChild(menu);
            
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function copyRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            document.getElementById('modalTitle').textContent = '复制发布任务';
            loadProjects();
            setTimeout(() => {
                document.querySelector('select[name="projectId"]').value = release.projectId || '';
                document.querySelector('input[name="applicationId"]').value = release.applicationId || '';
                document.querySelector('input[name="version"]').value = release.version + '-copy';
                document.querySelector('select[name="environment"]').value = release.environment || '';
                document.querySelector('select[name="strategy"]').value = release.strategy || '';
                document.querySelector('textarea[name="description"]').value = '复制自: ' + release.version;
                document.getElementById('modal').classList.add('active');
            }, 100);
        }

        function exportRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            const report = `
版本发布报告
============

项目名称: ${release.projectName || release.projectId}
版本号: ${release.version}
环境: ${release.environment}
策略: ${release.strategy}
状态: ${release.status}
发布人: ${release.scheduler}
创建时间: ${new Date(release.createdAt).toLocaleString()}
构建包: ${release.tarFileName || '无'}
GitLab PR: ${release.gitlabPrUrl || '无'}
描述: ${release.description || '无'}
            `.trim();
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `release-${release.version}-report.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function showGrayRecords(releaseId) {
            const release = currentReleases.find(r => r.id === releaseId);
            if (!release) return;
            
            try {
                const response = await fetch(`/api/v1/gray-releases?projectId=${release.projectId}&environment=${release.environment}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const grayReleases = (data.data || []).filter(gr => gr.version === release.version);
                    renderGrayRecords(grayReleases, release);
                    document.getElementById('grayRecordsModal').classList.add('active');
                } else {
                    alert('加载灰度记录失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载灰度记录失败:', error);
                alert('加载灰度记录失败');
            }
        }

        function renderGrayRecords(grayReleases, release) {
            const container = document.getElementById('grayRecordsContent');
            
            if (grayReleases.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <p>版本 <strong>${release.version}</strong> 暂无灰度发布记录</p>
                        <button class="btn" onclick="goToGrayManagement('${release.projectId}', '${release.environment}', '${release.version}')">创建灰度规则</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f0f5ff; border-radius: 6px;">
                    <strong>版本:</strong> ${release.version} | 
                    <strong>项目:</strong> ${release.projectName || release.projectId} | 
                    <strong>环境:</strong> ${release.environment}
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #fafafa; border-bottom: 2px solid #f0f0f0;">
                            <th style="padding: 12px; text-align: left;">策略类型</th>
                            <th style="padding: 12px; text-align: left;">灰度规则</th>
                            <th style="padding: 12px; text-align: left;">状态</th>
                            <th style="padding: 12px; text-align: left;">操作人</th>
                            <th style="padding: 12px; text-align: left;">创建时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${grayReleases.map(gr => {
                            const statusName = gr.status === 'active' ? '进行中' : '已完成';
                            const statusColor = gr.status === 'active' ? '#52c41a' : '#8c8c8c';
                            
                            let strategyType = '简单规则';
                            let rulesText = '';
                            
                            if (gr.strategyType === 'advanced' && gr.strategies) {
                                strategyType = '高级策略';
                                rulesText = gr.strategies.map(s => {
                                    const typeMap = { percentage: '百分比', hash: '哈希', whitelist: '白名单', blacklist: '黑名单', dimension: '维度', time_window: '时间窗口' };
                                    const typeName = typeMap[s.type] || s.type;
                                    if (s.type === 'percentage') return `${typeName}: ${s.percentage}%`;
                                    if (s.type === 'hash') return `${typeName}: ${s.hashKey}`;
                                    if (s.type === 'dimension') {
                                        const dimMap = { isp: '运营商', region: '大区', province: '省份', datacenter: '机房' };
                                        return `${dimMap[s.dimension] || s.dimension}: ${s.values.join(', ')}`;
                                    }
                                    if (s.values) return `${typeName}: ${s.values.join(', ')}`;
                                    return typeName;
                                }).join(' | ');
                                if (gr.ruleLogic) rulesText = `[${gr.ruleLogic}] ` + rulesText;
                            } else if (gr.rules) {
                                rulesText = gr.rules.map(r => {
                                    const dimMap = { isp: '运营商', region: '大区', province: '省份', datacenter: '机房' };
                                    return `${dimMap[r.dimension] || r.dimension}: ${r.values.join(', ')}`;
                                }).join(' | ');
                            }
                            
                            return `
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 12px;"><span style="background: #f0f5ff; color: #1890ff; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${strategyType}</span></td>
                                    <td style="padding: 12px;">${rulesText}</td>
                                    <td style="padding: 12px;"><span style="color: ${statusColor}; font-weight: 500;">${statusName}</span></td>
                                    <td style="padding: 12px;">${gr.operator}</td>
                                    <td style="padding: 12px;">${new Date(gr.createdAt).toLocaleString('zh-CN')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function hideGrayRecordsModal() {
            document.getElementById('grayRecordsModal').classList.remove('active');
        }

        function goToGrayManagement(projectId, environment, version) {
            window.location.href = `/config?tab=gray&projectId=${projectId}&env=${environment}`;
        }

        loadReleases();
        setInterval(loadReleases, 5000);
    </script>
</body>
</html>
