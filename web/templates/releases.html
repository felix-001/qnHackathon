<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘å¸ƒç®¡ç† - æ™ºèƒ½å‘å¸ƒæ§åˆ¶å°</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .delete-mode { background: #ffe7ba; }
    </style>
</head>
<body>
    <div class="header">æ™ºèƒ½å‘å¸ƒæ§åˆ¶å°</div>
    <div class="container">
        <div class="sidebar">
            <a href="/projects" class="menu-item">é¡¹ç›®ç®¡ç†</a>
            <a href="/releases" class="menu-item active">å‘å¸ƒç®¡ç†</a>
            <a href="/monitoring" class="menu-item">ç›‘æ§é¢æ¿</a>
            <a href="/config" class="menu-item">é…ç½®ç®¡ç†</a>
        </div>
        <div class="content">
            <button class="btn" onclick="showModal()">åˆ›å»ºå‘å¸ƒ</button>
            <button class="btn btn-secondary" id="toggleDeleteMode" onclick="toggleDeleteMode()">è¿›å…¥åˆ é™¤æ¨¡å¼</button>
            <button class="btn btn-danger" id="deleteSelected" onclick="deleteSelected()" style="display: none;">åˆ é™¤é€‰ä¸­</button>
            <table>
                <thead>
                    <tr>
                        <th id="checkboxHeader" style="display: none; width: 50px;">
                            <input type="checkbox" id="selectAll" onchange="selectAllReleases()">
                        </th>
                        <th>é¡¹ç›®åç§°</th>
                        <th>ç‰ˆæœ¬</th>
                        <th>ç¯å¢ƒ</th>
                        <th>ç­–ç•¥</th>
                        <th>çŠ¶æ€</th>
                        <th>å‘å¸ƒäºº</th>
                        <th>æ„å»ºåŒ…</th>
                        <th>GitLab PR</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="releaseList"></tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">åˆ›å»ºå‘å¸ƒä»»åŠ¡</h2>
            <form id="releaseForm">
                <input type="hidden" name="id" id="releaseId">
                <div class="form-group">
                    <label>é¡¹ç›®åç§°</label>
                    <select name="projectId" id="projectSelect" required>
                        <option value="">è¯·é€‰æ‹©é¡¹ç›®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åº”ç”¨ID</label>
                    <input type="text" name="applicationId" required>
                </div>
                <div class="form-group">
                    <label>ç‰ˆæœ¬</label>
                    <input type="text" name="version" required>
                </div>
                <div class="form-group">
                    <label>ç¯å¢ƒ</label>
                    <select name="environment">
                        <option value="dev">å¼€å‘ç¯å¢ƒ</option>
                        <option value="test">æµ‹è¯•ç¯å¢ƒ</option>
                        <option value="staging">é¢„å‘å¸ƒç¯å¢ƒ</option>
                        <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‘å¸ƒç­–ç•¥</label>
                    <select name="strategy">
                        <option value="blue-green">è“ç»¿éƒ¨ç½²</option>
                        <option value="canary">é‡‘ä¸é›€å‘å¸ƒ</option>
                        <option value="rolling-update">æ»šåŠ¨æ›´æ–°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>GitLab PRé“¾æ¥</label>
                    <input type="text" name="gitlabPrUrl">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <button type="submit" class="btn">æäº¤</button>
                <button type="button" class="btn" onclick="hideModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <div id="grayModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>ç°åº¦å‘å¸ƒé…ç½®</h2>
            <div class="form-group">
                <label>ç‰ˆæœ¬ä¿¡æ¯</label>
                <div id="grayVersionInfo" style="padding: 8px; background: #f5f5f5; border-radius: 4px; color: #666;"></div>
            </div>
            <div class="form-group">
                <label>ç»„åˆé€»è¾‘</label>
                <select id="grayRuleLogic">
                    <option value="AND">AND (æ‰€æœ‰ç­–ç•¥éƒ½åŒ¹é…)</option>
                    <option value="OR">OR (ä»»ä¸€ç­–ç•¥åŒ¹é…)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç°åº¦ç­–ç•¥</label>
                <div id="grayStrategiesContainer"></div>
                <button type="button" class="btn" onclick="addGrayStrategy()" style="margin-top: 8px;">æ·»åŠ ç­–ç•¥</button>
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="grayDescription" placeholder="ç®€è¦è¯´æ˜ç°åº¦ç›®çš„"></textarea>
            </div>
            <div class="btn-group">
                <button type="button" class="btn" style="background: #d9d9d9; color: #333;" onclick="hideGrayModal()">å–æ¶ˆ</button>
                <button type="button" class="btn" onclick="saveGrayConfig()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        let currentReleases = [];
        let editingReleaseId = null;
        let deleteMode = false;
        let selectedReleases = new Set();
        let projects = [];

        function showModal() {
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºå‘å¸ƒä»»åŠ¡';
            document.getElementById('releaseForm').reset();
            document.getElementById('releaseId').value = '';
            editingReleaseId = null;
            loadProjects();
            document.getElementById('modal').classList.add('active');
        }
        function hideModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('releaseForm').reset();
            editingReleaseId = null;
        }

        function getStatusTag(status) {
            const map = {
                'pending_approval': '<span class="tag tag-orange">å¾…å®¡æ‰¹</span>',
                'approved': '<span class="tag tag-blue">å·²æ‰¹å‡†</span>',
                'deploying': '<span class="tag tag-blue">å‘å¸ƒä¸­</span>',
                'completed': '<span class="tag tag-green">å‘å¸ƒå®Œæˆ</span>',
                'failed': '<span class="tag tag-red">å¤±è´¥</span>',
                'rolled_back': '<span class="tag">å·²å›æ»š</span>'
            };
            return map[status] || status;
        }

        function getActionButton(release) {
            if (release.status === 'pending_approval') {
                return `<button class="btn btn-edit" onclick="approveRelease('${release.id}')">reviewé€šè¿‡</button>`;
            } else if (release.status === 'approved') {
                return `<button class="btn" onclick="deployRelease('${release.id}')">å‘å¸ƒ</button>`;
            } else if (release.status === 'completed') {
                return `
                    <div class="action-buttons">
                        <button class="btn-rollback" onclick="rollback('${release.id}')">å›æ»š</button>
                        <button class="btn-full-release" onclick="fullRelease('${release.id}')">å…¨é‡</button>
                        <button class="btn-gray-release" onclick="grayRelease('${release.id}')">ç°åº¦</button>
                        <button class="btn-more" onclick="showMoreMenu('${release.id}', event)">æ›´å¤š</button>
                    </div>
                `;
            }
            return '';
        }

        function loadReleases() {
            fetch('/api/v1/releases')
                .then(res => res.json())
                .then(data => {
                    currentReleases = data.data || [];
                    const tbody = document.getElementById('releaseList');
                    tbody.innerHTML = (data.data || []).map(r => `
                        <tr>
                            <td style="display: ${deleteMode ? 'table-cell' : 'none'};">
                                <input type="checkbox" class="release-checkbox" value="${r.id}" onchange="updateSelection('${r.id}')">
                            </td>
                            <td>${r.projectName || r.projectId || '-'}</td>
                            <td>${r.version}</td>
                            <td>${r.environment}</td>
                            <td>${r.strategy}</td>
                            <td>${getStatusTag(r.status)}</td>
                            <td>${r.scheduler}</td>
                            <td>${r.tarFileName || 'æ„å»ºä¸­...'}</td>
                            <td>${r.gitlabPrUrl ? `<a href="${r.gitlabPrUrl}" target="_blank">æŸ¥çœ‹PR</a>` : 'æ„å»ºä¸­...'}</td>
                            <td>${new Date(r.createdAt).toLocaleString()}</td>
                            <td>${getActionButton(r)}</td>
                        </tr>
                    `).join('');
                });
        }

        function loadProjects() {
            fetch('/api/v1/projects')
                .then(res => res.json())
                .then(data => {
                    projects = data.data || [];
                    const select = document.getElementById('projectSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡¹ç›®</option>';
                    projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        select.appendChild(option);
                    });
                });
        }

        function editRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (release) {
                editingReleaseId = id;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å‘å¸ƒä»»åŠ¡';
                document.getElementById('releaseId').value = release.id;
                loadProjects();
                setTimeout(() => {
                    document.querySelector('select[name="projectId"]').value = release.projectId || '';
                }, 100);
                document.querySelector('input[name="applicationId"]').value = release.applicationId || '';
                document.querySelector('input[name="version"]').value = release.version || '';
                document.querySelector('select[name="environment"]').value = release.environment || '';
                document.querySelector('select[name="strategy"]').value = release.strategy || '';
                document.querySelector('input[name="gitlabPrUrl"]').value = release.gitlabPrUrl || '';
                document.querySelector('textarea[name="description"]').value = release.description || '';
                document.getElementById('modal').classList.add('active');
            }
        }

        document.getElementById('releaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            if (editingReleaseId) {
                data.id = editingReleaseId;
                fetch(`/api/v1/releases/${editingReleaseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    hideModal();
                    loadReleases();
                });
            } else {
                data.id = 'rel-' + Date.now();
                data.scheduler = 'admin';
                fetch('/api/v1/releases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    hideModal();
                    loadReleases();
                });
            }
        });

        function rollback(id) {
            if (confirm('ç¡®å®šå›æ»š?')) {
                fetch(`/api/v1/releases/${id}/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetVersion: 'previous', reason: 'æ‰‹åŠ¨å›æ»š' })
                }).then(() => loadReleases());
            }
        }

        function approveRelease(id) {
            if (confirm('ç¡®è®¤reviewé€šè¿‡?')) {
                fetch(`/api/v1/releases/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(() => {
                    loadReleases();
                });
            }
        }

        function deployRelease(id) {
            if (confirm('ç¡®è®¤å‘å¸ƒ?')) {
                fetch(`/api/v1/releases/${id}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(() => {
                    setTimeout(() => loadReleases(), 1000);
                });
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedReleases.clear();
            
            const toggleBtn = document.getElementById('toggleDeleteMode');
            const deleteBtn = document.getElementById('deleteSelected');
            const checkboxHeader = document.getElementById('checkboxHeader');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (deleteMode) {
                toggleBtn.textContent = 'é€€å‡ºåˆ é™¤æ¨¡å¼';
                toggleBtn.classList.add('btn-secondary');
                deleteBtn.style.display = 'inline-block';
                checkboxHeader.style.display = 'table-cell';
            } else {
                toggleBtn.textContent = 'è¿›å…¥åˆ é™¤æ¨¡å¼';
                toggleBtn.classList.remove('btn-secondary');
                deleteBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
                selectAllCheckbox.checked = false;
            }
            
            loadReleases();
        }

        function updateSelection(id) {
            if (selectedReleases.has(id)) {
                selectedReleases.delete(id);
            } else {
                selectedReleases.add(id);
            }
            
            const deleteBtn = document.getElementById('deleteSelected');
            deleteBtn.textContent = `åˆ é™¤é€‰ä¸­ (${selectedReleases.size})`;
            
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.release-checkbox');
            selectAllCheckbox.checked = checkboxes.length > 0 && selectedReleases.size === checkboxes.length;
        }

        function selectAllReleases() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.release-checkbox');
            
            selectedReleases.clear();
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedReleases.add(cb.value);
                }
            });
            
            const deleteBtn = document.getElementById('deleteSelected');
            deleteBtn.textContent = `åˆ é™¤é€‰ä¸­ (${selectedReleases.size})`;
        }

        function deleteSelected() {
            if (selectedReleases.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹');
                return;
            }
            
            const count = selectedReleases.size;
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} é¡¹å‘å¸ƒä»»åŠ¡?`)) {
                const ids = Array.from(selectedReleases);
                fetch('/api/v1/releases/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 0) {
                        selectedReleases.clear();
                        loadReleases();
                        alert('åˆ é™¤æˆåŠŸ');
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => {
                    alert('åˆ é™¤å¤±è´¥: ' + err.message);
                });
            }
        }

        function fullRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            if (confirm(`ç¡®è®¤å¯¹ç‰ˆæœ¬ ${release.version} æ‰§è¡Œå…¨é‡å‘å¸ƒ?`)) {
                fetch('/api/v1/gray-releases/full-release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        releaseId: id,
                        projectId: release.projectId,
                        environment: release.environment,
                        version: release.version,
                        strategy: release.strategy,
                        description: 'å…¨é‡å‘å¸ƒ',
                        operator: 'admin'
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200 || data.code === 0) {
                        alert('âœ… å…¨é‡å‘å¸ƒæˆåŠŸ');
                        loadReleases();
                    } else {
                        alert('âŒ å…¨é‡å‘å¸ƒå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    alert('âŒ å…¨é‡å‘å¸ƒå¤±è´¥: ' + err.message);
                });
            }
        }

        let currentGrayRelease = null;
        let grayStrategyCounter = 0;

        function grayRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            currentGrayRelease = release;
            document.getElementById('grayVersionInfo').textContent = `é¡¹ç›®: ${release.projectName || release.projectId} | ç‰ˆæœ¬: ${release.version} | ç¯å¢ƒ: ${release.environment}`;
            document.getElementById('grayRuleLogic').value = 'AND';
            document.getElementById('grayDescription').value = '';
            document.getElementById('grayStrategiesContainer').innerHTML = '';
            grayStrategyCounter = 0;
            
            addGrayStrategy();
            document.getElementById('grayModal').classList.add('active');
        }

        function hideGrayModal() {
            document.getElementById('grayModal').classList.remove('active');
            currentGrayRelease = null;
        }

        function addGrayStrategy() {
            const strategyId = 'strategy-' + (++grayStrategyCounter);
            const container = document.getElementById('grayStrategiesContainer');
            
            const strategyHtml = `
                <div id="${strategyId}" class="strategy-item" style="border: 1px solid #d9d9d9; padding: 12px; margin-bottom: 8px; border-radius: 4px; background: #fafafa;">
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <div style="flex: 1;">
                            <select class="strategy-type" onchange="updateStrategyFields('${strategyId}')" style="width: 100%; padding: 6px; margin-bottom: 8px;">
                                <option value="">é€‰æ‹©ç­–ç•¥ç±»å‹</option>
                                <option value="percentage">ç™¾åˆ†æ¯”ç°åº¦</option>
                                <option value="hash">å“ˆå¸Œç°åº¦</option>
                                <option value="whitelist">ç™½åå•</option>
                                <option value="blacklist">é»‘åå•</option>
                                <option value="dimension">ç»´åº¦åŒ¹é…</option>
                                <option value="time_window">æ—¶é—´çª—å£</option>
                            </select>
                            <div class="strategy-fields"></div>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeGrayStrategy('${strategyId}')" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">åˆ é™¤</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', strategyHtml);
        }

        function removeGrayStrategy(strategyId) {
            document.getElementById(strategyId).remove();
        }

        function updateStrategyFields(strategyId) {
            const strategyItem = document.getElementById(strategyId);
            const type = strategyItem.querySelector('.strategy-type').value;
            const fieldsContainer = strategyItem.querySelector('.strategy-fields');
            
            let fieldsHtml = '';
            switch(type) {
                case 'percentage':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">ç™¾åˆ†æ¯” (1-100)</label>
                        <input type="number" class="field-percentage" min="1" max="100" placeholder="10" style="width: 100%; padding: 6px;">
                    `;
                    break;
                case 'hash':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">å“ˆå¸Œå­—æ®µ</label>
                        <select class="field-hashField" style="width: 100%; padding: 6px;">
                            <option value="nodeId">èŠ‚ç‚¹ID</option>
                            <option value="nodeName">èŠ‚ç‚¹åç§°</option>
                        </select>
                    `;
                    break;
                case 'whitelist':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">èŠ‚ç‚¹åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                        <textarea class="field-values" placeholder="node-001, node-002, node-003" style="width: 100%; padding: 6px; min-height: 60px;"></textarea>
                    `;
                    break;
                case 'blacklist':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">æ’é™¤èŠ‚ç‚¹åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                        <textarea class="field-values" placeholder="node-001, node-002" style="width: 100%; padding: 6px; min-height: 60px;"></textarea>
                    `;
                    break;
                case 'dimension':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">ç»´åº¦ç±»å‹</label>
                        <select class="field-dimension" style="width: 100%; padding: 6px; margin-bottom: 8px;">
                            <option value="isp">è¿è¥å•† (ISP)</option>
                            <option value="region">å¤§åŒº (Region)</option>
                            <option value="province">çœä»½ (Province)</option>
                            <option value="datacenter">æœºæˆ¿ (DataCenter)</option>
                        </select>
                        <label style="font-size: 12px; color: #666;">å€¼åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                        <input type="text" class="field-values" placeholder="beijing, shanghai" style="width: 100%; padding: 6px;">
                    `;
                    break;
                case 'time_window':
                    fieldsHtml = `
                        <label style="font-size: 12px; color: #666;">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" class="field-startTime" style="width: 100%; padding: 6px; margin-bottom: 8px;">
                        <label style="font-size: 12px; color: #666;">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" class="field-endTime" style="width: 100%; padding: 6px;">
                    `;
                    break;
            }
            fieldsContainer.innerHTML = fieldsHtml;
        }

        function getGrayStrategies() {
            const strategies = [];
            document.querySelectorAll('.strategy-item').forEach(item => {
                const type = item.querySelector('.strategy-type').value;
                if (!type) return;
                
                const strategy = { type };
                
                switch(type) {
                    case 'percentage':
                        const pct = parseInt(item.querySelector('.field-percentage').value);
                        if (isNaN(pct) || pct < 1 || pct > 100) return;
                        strategy.percentage = pct;
                        break;
                    case 'hash':
                        strategy.hashField = item.querySelector('.field-hashField').value;
                        break;
                    case 'whitelist':
                    case 'blacklist':
                        const values = item.querySelector('.field-values').value;
                        if (!values.trim()) return;
                        strategy.values = values.split(',').map(v => v.trim()).filter(v => v);
                        break;
                    case 'dimension':
                        const dimension = item.querySelector('.field-dimension').value;
                        const dimValues = item.querySelector('.field-values').value;
                        if (!dimension || !dimValues.trim()) return;
                        strategy.dimension = dimension;
                        strategy.values = dimValues.split(',').map(v => v.trim()).filter(v => v);
                        break;
                    case 'time_window':
                        const startTime = item.querySelector('.field-startTime').value;
                        const endTime = item.querySelector('.field-endTime').value;
                        if (!startTime || !endTime) return;
                        strategy.startTime = new Date(startTime).toISOString();
                        strategy.endTime = new Date(endTime).toISOString();
                        break;
                }
                
                strategies.push(strategy);
            });
            return strategies;
        }

        function saveGrayConfig() {
            if (!currentGrayRelease) return;
            
            const strategies = getGrayStrategies();
            if (strategies.length === 0) {
                alert('âŒ è¯·è‡³å°‘é…ç½®ä¸€ä¸ªæœ‰æ•ˆçš„ç°åº¦ç­–ç•¥');
                return;
            }
            
            const ruleLogic = document.getElementById('grayRuleLogic').value;
            const description = document.getElementById('grayDescription').value;
            
            const config = {
                releaseId: currentGrayRelease.id,
                projectId: currentGrayRelease.projectId,
                projectName: currentGrayRelease.projectName,
                environment: currentGrayRelease.environment,
                version: currentGrayRelease.version,
                name: `${currentGrayRelease.version} ç°åº¦å‘å¸ƒ`,
                strategyType: 'advanced',
                ruleLogic: ruleLogic,
                strategies: strategies,
                description: description || 'ç°åº¦å‘å¸ƒ',
                operator: 'admin',
                autoPromote: false,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            fetch('/api/v1/gray-releases', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200 || data.code === 0) {
                    alert(`âœ… ç°åº¦å‘å¸ƒé…ç½®åˆ›å»ºæˆåŠŸ`);
                    hideGrayModal();
                    loadReleases();
                } else {
                    alert('âŒ ç°åº¦å‘å¸ƒé…ç½®åˆ›å»ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(err => {
                alert('âŒ ç°åº¦å‘å¸ƒé…ç½®åˆ›å»ºå¤±è´¥: ' + err.message);
            });
        }

        function showMoreMenu(id, event) {
            event.stopPropagation();
            
            const existingMenu = document.getElementById('moreMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            const menu = document.createElement('div');
            menu.id = 'moreMenu';
            menu.className = 'more-menu';
            
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            const menuItems = [
                { icon: 'ğŸ“‹', label: 'æŸ¥çœ‹è¯¦æƒ…', action: () => alert('ç‰ˆæœ¬è¯¦æƒ…:\n' + JSON.stringify(release, null, 2)) },
                { icon: 'ğŸ“‘', label: 'å¤åˆ¶ç‰ˆæœ¬', action: () => copyRelease(id) },
                { icon: 'ğŸ”', label: 'å¯¹æ¯”ç‰ˆæœ¬', action: () => alert('å¯¹æ¯”ç‰ˆæœ¬åŠŸèƒ½å¼€å‘ä¸­...') },
                { icon: 'ğŸ“', label: 'æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—', action: () => alert('éƒ¨ç½²æ—¥å¿—:\nå‘å¸ƒæ—¶é—´: ' + new Date(release.createdAt).toLocaleString()) },
                { icon: 'âœï¸', label: 'ç¼–è¾‘ç‰ˆæœ¬ä¿¡æ¯', action: () => editRelease(id) },
                { divider: true },
                { icon: 'ğŸ’¾', label: 'å¯¼å‡ºç‰ˆæœ¬æŠ¥å‘Š', action: () => exportRelease(id) }
            ];
            
            menuItems.forEach(item => {
                if (item.divider) {
                    const divider = document.createElement('div');
                    divider.className = 'more-menu-divider';
                    menu.appendChild(divider);
                } else {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'more-menu-item';
                    menuItem.innerHTML = `<span>${item.icon}</span><span>${item.label}</span>`;
                    menuItem.onclick = () => {
                        item.action();
                        menu.remove();
                    };
                    menu.appendChild(menuItem);
                }
            });
            
            document.body.appendChild(menu);
            
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function copyRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            document.getElementById('modalTitle').textContent = 'å¤åˆ¶å‘å¸ƒä»»åŠ¡';
            loadProjects();
            setTimeout(() => {
                document.querySelector('select[name="projectId"]').value = release.projectId || '';
                document.querySelector('input[name="applicationId"]').value = release.applicationId || '';
                document.querySelector('input[name="version"]').value = release.version + '-copy';
                document.querySelector('select[name="environment"]').value = release.environment || '';
                document.querySelector('select[name="strategy"]').value = release.strategy || '';
                document.querySelector('textarea[name="description"]').value = 'å¤åˆ¶è‡ª: ' + release.version;
                document.getElementById('modal').classList.add('active');
            }, 100);
        }

        function exportRelease(id) {
            const release = currentReleases.find(r => r.id === id);
            if (!release) return;
            
            const report = `
ç‰ˆæœ¬å‘å¸ƒæŠ¥å‘Š
============

é¡¹ç›®åç§°: ${release.projectName || release.projectId}
ç‰ˆæœ¬å·: ${release.version}
ç¯å¢ƒ: ${release.environment}
ç­–ç•¥: ${release.strategy}
çŠ¶æ€: ${release.status}
å‘å¸ƒäºº: ${release.scheduler}
åˆ›å»ºæ—¶é—´: ${new Date(release.createdAt).toLocaleString()}
æ„å»ºåŒ…: ${release.tarFileName || 'æ— '}
GitLab PR: ${release.gitlabPrUrl || 'æ— '}
æè¿°: ${release.description || 'æ— '}
            `.trim();
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `release-${release.version}-report.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        loadReleases();
        setInterval(loadReleases, 5000);
    </script>
</body>
</html>
